<script>
(() => {
  const $contacts = document.getElementById('contacts');
  const $refresh  = document.getElementById('refresh');
  const $pause    = document.getElementById('pause');
  const $sendBtn  = document.getElementById('sendBtn');
  const $input    = document.getElementById('manualInput');
  const $tplBtn   = document.getElementById('tplBtn');
  const $tplSel   = document.getElementById('tplSelect');
  const $langSel  = document.getElementById('langSelect');
  const $history  = document.getElementById('history');

  // ——— Auth ———
  let secret = localStorage.getItem('fitmouv_admin_secret') || '';
  async function askSecret() {
    while (!secret) {
      secret = window.prompt('Admin secret ?') || '';
    }
    localStorage.setItem('fitmouv_admin_secret', secret);
  }
  function authHeaders() {
    const token = btoa(`admin:${secret}`);
    return { 'Authorization': `Basic ${token}`, 'Content-Type': 'application/json' };
  }

  // ——— UI state ———
  let current = null;

  function contactLine(c) {
    const name = (c.firstName || c.lastName) ? `${c.firstName || ''} ${c.lastName || ''}`.trim() : c.waId;
    const open = c.windowOpen ? '•' : '○';
    const paused = c.autoPaused ? '⏸️' : '';
    return `<div class="item" data-wa="${c.waId}">${open} ${name} ${paused}</div>`;
  }

  function setContacts(list) {
    $contacts.innerHTML = list.map(contactLine).join('') || '<div class="item">Aucun contact</div>';
    [...$contacts.querySelectorAll('.item')].forEach(el => {
      el.addEventListener('click', async () => {
        const waId = el.getAttribute('data-wa');
        current = waId;
        await loadHistory();
        el.parentElement.querySelectorAll('.item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
      });
    });
  }

  async function refreshContacts() {
    const r = await fetch('/admin/contacts', { headers: authHeaders() });
    if (!r.ok) {
      if (r.status === 401 || r.status === 403) { localStorage.removeItem('fitmouv_admin_secret'); secret = ''; await init(); return; }
      throw new Error(await r.text());
    }
    const data = await r.json();
    setContacts(data.contacts || []);
  }

  async function loadHistory() {
    if (!current) { $history.innerHTML = ''; return; }
    const r = await fetch('/admin/history?waId=' + encodeURIComponent(current), { headers: authHeaders() });
    const data = await r.json();
    const items = (data.history || []).slice(-200).map(h => {
      const who = h.role === 'user' ? 'client' : 'coach';
      const t = new Date(h.at || Date.now()).toLocaleString();
      return `<div class="bubble ${who}"><div class="time">${t}</div><div class="txt">${(h.text || '').replace(/</g,'&lt;')}</div></div>`;
    });
    $history.innerHTML = items.join('') || '<div class="muted">Aucun échange pour l’instant.</div>';
    $history.scrollTop = $history.scrollHeight;
  }

  // ——— actions ———
  async function sendText() {
    if (!current) return alert('Choisis un contact');
    const text = ($input.value || '').trim();
    if (!text) return;
    const r = await fetch('/admin/send-text', {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify({ waId: current, text })
    });
    if (r.ok) { $input.value=''; await loadHistory(); }
    else alert('Erreur envoi texte');
  }

  async function sendTemplate() {
    if (!current) return alert('Choisis un contact');
    const tpl  = $tplSel.value;
    const lang = $langSel.value || 'fr';
    const r = await fetch('/admin/send-template', {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify({ waId: current, template: tpl, lang })
    });
    if (r.ok) { await loadHistory(); }
    else alert('Erreur envoi template');
  }

  async function togglePause() {
    if (!current) return;
    const paused = $pause.checked;
    await fetch('/admin/pause', {
      method: 'POST',
      headers: authHeaders(),
      body: JSON.stringify({ waId: current, paused })
    });
    await refreshContacts();
  }

  // ——— bind ———
  $refresh.addEventListener('click', refreshContacts);
  $sendBtn.addEventListener('click', sendText);
  $tplBtn.addEventListener('click', sendTemplate);
  $pause.addEventListener('change', togglePause);
  $input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendText(); }});

  // ——— init ———
  async function init() {
    if (!secret) await askSecret();
    await refreshContacts();
  }
  init();
})();
</script>
