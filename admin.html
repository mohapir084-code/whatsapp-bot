<script>
(() => {
  const $ = (sel) => document.querySelector(sel);
  const listEl = document.getElementById('list');
  const chatEl = document.getElementById('chat');
  const pauseEl = document.getElementById('pause');
  const tplSel = document.getElementById('tpl');
  const langSel = document.getElementById('lang');
  const btnSendTpl = document.getElementById('sendTpl');
  const inputMsg = document.getElementById('msg');
  const btnSend = document.getElementById('send');
  const btnRefresh = document.getElementById('refresh');

  let AUTH = '';
  let current = null;
  let contacts = [];

  function uiError(msg) {
    console.error(msg);
    chatEl.innerHTML = `<div style="padding:16px;color:#b00;">${msg}</div>`;
  }
  function renderList() {
    listEl.innerHTML = '';
    if (!contacts.length) {
      listEl.innerHTML = `<div style="padding:8px;color:#888;">(Aucun contact encore)</div>`;
      return;
    }
    for (const c of contacts) {
      const div = document.createElement('div');
      div.className = 'item';
      div.textContent = `${c.firstname || ''} ${c.lastname || ''} · ${c.waId}`;
      div.onclick = () => openChat(c.waId);
      listEl.appendChild(div);
    }
  }
  function renderChat(h = []) {
    chatEl.innerHTML = '';
    if (!h.length) {
      chatEl.innerHTML = `<div style="padding:16px;color:#777;">(Pas d'historique pour le moment)</div>`;
      return;
    }
    for (const m of h) {
      const d = document.createElement('div');
      d.className = 'bubble ' + (m.role === 'user' ? 'user' : 'bot');
      d.innerHTML = `<div class="msg">${(m.text || '').replace(/</g,'&lt;')}</div>
                     <div class="meta">${new Date(m.at||Date.now()).toLocaleString()}</div>`;
      chatEl.appendChild(d);
    }
    chatEl.scrollTop = chatEl.scrollHeight;
  }
  function authHeader() {
    return AUTH ? { 'Authorization': AUTH } : {};
  }
  async function apiGet(path) {
    const res = await fetch(path, { headers: { 'Accept':'application/json', ...authHeader() } });
    if (res.status === 401 || res.status === 403) throw new Error('AUTH');
    return res.json();
  }
  async function apiPost(path, body) {
    const res = await fetch(path, {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Accept':'application/json', ...authHeader() },
      body: JSON.stringify(body || {})
    });
    if (res.status === 401 || res.status === 403) throw new Error('AUTH');
    return res.json();
  }

  async function ensureAuth() {
    if (AUTH) return;
    const secret = prompt('Admin secret ?') || '';
    AUTH = 'Basic ' + btoa('admin:' + secret);
  }

  async function loadContacts() {
    try {
      await ensureAuth();
      const data = await apiGet('/admin/api/contacts');
      if (!data.ok) throw new Error('contacts not ok');
      contacts = data.contacts || [];
      renderList();
    } catch (e) {
      if (e.message === 'AUTH') {
        AUTH = '';
        uiError('⚠️ Accès refusé (401). Clique “Rafraîchir” pour réessayer et entre le bon secret.');
        return;
      }
      uiError('Erreur chargement contacts : ' + e.message);
    }
  }

  async function openChat(waId) {
    current = waId;
    try {
      await ensureAuth();
      const data = await apiGet('/admin/api/chat/' + encodeURIComponent(waId));
      if (!data.ok) throw new Error('chat not ok');
      renderChat(data.history || []);
      pauseEl.checked = !!data.autoPaused;
    } catch (e) {
      if (e.message === 'AUTH') {
        AUTH = '';
        uiError('⚠️ Accès refusé (401). Clique “Rafraîchir” et réessaie.');
        return;
      }
      uiError('Erreur ouverture chat : ' + e.message);
    }
  }

  async function sendText() {
    if (!current) return;
    const text = (inputMsg.value || '').trim();
    if (!text) return;
    try {
      await ensureAuth();
      const r = await apiPost('/admin/api/send-text', { waId: current, text });
      if (!r.ok) throw new Error(r.error || 'send-text not ok');
      inputMsg.value = '';
      openChat(current);
    } catch (e) {
      if (e.message === 'AUTH') { AUTH = ''; uiError('⚠️ 401 sur envoi texte. Rafraîchis.'); return; }
      uiError('Erreur envoi texte : ' + e.message);
    }
  }

  async function sendTpl() {
    if (!current) return;
    const template = tplSel.value;
    const lang = langSel.value || 'fr';
    try {
      await ensureAuth();
      const r = await apiPost('/admin/api/send-template', { waId: current, template, lang });
      if (!r.ok) throw new Error(r.error || 'send-template not ok');
      openChat(current);
    } catch (e) {
      if (e.message === 'AUTH') { AUTH = ''; uiError('⚠️ 401 sur envoi template. Rafraîchis.'); return; }
      uiError('Erreur envoi template : ' + e.message);
    }
  }

  async function togglePause() {
    if (!current) return;
    try {
      await ensureAuth();
      const r = await apiPost('/admin/api/pause', { waId: current, paused: pauseEl.checked });
      if (!r.ok) throw new Error(r.error || 'pause not ok');
    } catch (e) {
      if (e.message === 'AUTH') { AUTH = ''; uiError('⚠️ 401 sur pause. Rafraîchis.'); return; }
      uiError('Erreur pause : ' + e.message);
    }
  }

  btnRefresh.onclick = loadContacts;
  btnSend.onclick = sendText;
  btnSendTpl.onclick = sendTpl;
  pauseEl.onchange = togglePause;

  // 1er affichage
  renderList();      // affiche au moins “Aucun contact…”
  renderChat([]);    // zone vide propre
  loadContacts();    // déclenche prompt + fetch
})();
</script>
