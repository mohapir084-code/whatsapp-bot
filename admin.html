<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>FitMouv – Admin WhatsApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --b:#eee; --m:#667; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{display:flex;gap:12px;align-items:center;border-bottom:1px solid var(--b);padding:10px 14px}
    .muted{color:var(--m);font-size:12px}
    .row{display:flex;height:calc(100vh - 52px)}
    aside{width:340px;border-right:1px solid var(--b);overflow:auto}
    main{flex:1;display:flex;flex-direction:column}
    .conv{padding:10px 12px;border-bottom:1px solid #f3f3f3;cursor:pointer}
    .conv:hover{background:#fafafa}
    .badge{font-size:11px;padding:2px 6px;border-radius:6px;margin-left:6px}
    .open{background:#ddffdd}.closed{background:#ffdcdc}
    .msgs{flex:1;overflow:auto;padding:16px;background:#fff}
    .msg{margin:8px 0;max-width:70%;padding:8px 10px;border-radius:10px}
    .user{background:#f0f7ff;align-self:flex-start}
    .assistant{background:#eaffea;align-self:flex-end}
    .system{background:#fff3cd;align-self:center}
    .topbar{padding:8px 12px;border-bottom:1px solid var(--b);display:flex;gap:8px;align-items:center}
    .controls{border-top:1px solid var(--b);padding:12px;display:grid;grid-template-columns:1fr auto;gap:10px}
    .controls2{display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:8px}
    input,textarea,button{font:inherit}
    textarea{width:100%;height:80px}
  </style>
</head>
<body>
  <header>
    <strong>FitMouv – Admin WhatsApp</strong>
    <span class="muted">prise de contrôle / texte / template / audio</span>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <input id="adminSecret" type="password" placeholder="ADMIN_SECRET" />
      <button id="connect">Se connecter</button>
    </div>
  </header>

  <div class="row">
    <aside><div id="list"></div></aside>
    <main>
      <div class="topbar">
        <div id="title"><strong>Aucune conversation</strong></div>
        <div id="badges" class="muted"></div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="pauseBtn">Pause auto-relances</button>
          <button id="resumeBtn">Reprendre auto-relances</button>
        </div>
      </div>
      <div id="msgs" class="msgs"></div>
      <div class="controls">
        <textarea id="text" placeholder="Écrire un message texte…"></textarea>
        <button id="sendText">Envoyer</button>

        <div class="controls2" style="grid-column: span 2">
          <input id="audioUrl" placeholder="URL audio (mp3/ogg/m4a)" />
          <button id="sendAudio">Envoyer audio</button>
        </div>

        <div class="controls2" style="grid-column: span 2">
          <input id="tplName" placeholder="Nom du template (ex: fitmouv_welcome)" />
          <input id="tplLang" value="fr" />
          <button id="sendTpl">Envoyer template</button>
        </div>

        <div style="grid-column: span 2" class="muted">
          Rappel : si la fenêtre 24h est fermée, utilisez un <strong>template</strong>.
        </div>
      </div>
    </main>
  </div>

  <script>
    let authHeader = "";      // Basic admin: admin:ADMIN_SECRET
    let currentWaId = null;

    const $ = (id) => document.getElementById(id);
    const els = {
      list: $('list'), msgs: $('msgs'), title: $('title'), badges: $('badges'),
      adminSecret: $('adminSecret'), connect: $('connect'),
      text: $('text'), sendText: $('sendText'),
      audioUrl: $('audioUrl'), sendAudio: $('sendAudio'),
      tplName: $('tplName'), tplLang: $('tplLang'), sendTpl: $('sendTpl'),
      pauseBtn: $('pauseBtn'), resumeBtn: $('resumeBtn')
    };

    function btoaUtf8(s){ return btoa(unescape(encodeURIComponent(s))); }

    async function api(path, opts={}) {
      opts.headers = Object.assign({}, opts.headers || {}, {
        'Authorization': authHeader,
        'Content-Type': 'application/json'
      });
      const r = await fetch(path, opts);
      if (!r.ok) throw new Error(path + ' ' + r.status);
      return r.json();
    }

    function renderList(items){
      els.list.innerHTML = "";
      items.sort((a,b)=>(b.lastUserAt||0)-(a.lastUserAt||0));
      for(const c of items){
        const d = document.createElement('div');
        d.className = 'conv';
        d.innerHTML = `
          <div><strong>${c.firstname || c.phone || c.waId}</strong>
          <span class="badge ${c.windowOpen?'open':'closed'}">${c.windowOpen?'24h ouverte':'24h fermée'}</span>
          </div>
          <div class="muted">${(c.lastPreview||'').replace(/\n/g,' ')}</div>
        `;
        d.onclick = ()=> openChat(c.waId);
        els.list.appendChild(d);
      }
    }

    function renderChat(profile, history, windowOpen){
      els.msgs.innerHTML = "";
      els.title.innerHTML = `<strong>${profile.firstname || profile.phone || 'Conversation'}</strong>`;
      els.badges.textContent = windowOpen ? '24h ouverte' : '24h fermée';
      for(const m of history){
        const div = document.createElement('div');
        div.className = 'msg ' + (m.role==='user'?'user':(m.role==='assistant'?'assistant':'system'));
        div.textContent = m.text || '';
        els.msgs.appendChild(div);
      }
      els.msgs.scrollTop = els.msgs.scrollHeight;
    }

    async function loadList(){
      const data = await api('/admin/api/contacts');
      renderList(data.contacts || []);
    }

    async function openChat(waId){
      currentWaId = waId;
      const data = await api('/admin/api/chat/' + encodeURIComponent(waId));
      renderChat(data.profile || {}, data.history || [], !!data.windowOpen);
    }

    // Actions
    els.connect.onclick = async ()=>{
      const secret = els.adminSecret.value.trim();
      if(!secret) return alert('Saisis ADMIN_SECRET');
      authHeader = 'Basic ' + btoaUtf8('admin:' + secret);
      try { await loadList(); alert('Connecté'); }
      catch(e){ alert('Échec connexion (secret ?)'); }
    };

    els.sendText.onclick = async ()=>{
      if(!currentWaId) return;
      const text = els.text.value.trim();
      if(!text) return;
      try{
        await api('/admin/api/send-text', { method:'POST', body: JSON.stringify({ waId: currentWaId, text }) });
        els.text.value = '';
        await openChat(currentWaId);
        await loadList();
      }catch(e){ alert('Échec envoi texte (fenêtre fermée ?)'); }
    };

    els.sendAudio.onclick = async ()=>{
      if(!currentWaId) return;
      const audioUrl = els.audioUrl.value.trim();
      if(!audioUrl) return;
      try{
        await api('/admin/api/send-audio-url', { method:'POST', body: JSON.stringify({ waId: currentWaId, audioUrl }) });
        els.audioUrl.value = '';
        await openChat(currentWaId);
      }catch(e){ alert('Échec envoi audio'); }
    };

    els.sendTpl.onclick = async ()=>{
      if(!currentWaId) return;
      const template = els.tplName.value.trim();
      const lang = els.tplLang.value.trim() || 'fr';
      if(!template) return;
      try{
        await api('/admin/api/send-template', { method:'POST', body: JSON.stringify({ waId: currentWaId, template, lang }) });
        await openChat(currentWaId);
        await loadList();
      }catch(e){ alert('Échec envoi template'); }
    };

    els.pauseBtn.onclick = async ()=>{
      if(!currentWaId) return;
      await api('/admin/api/pause', { method:'POST', body: JSON.stringify({ waId: currentWaId, paused:true }) });
      await openChat(currentWaId);
    };
    els.resumeBtn.onclick = async ()=>{
      if(!currentWaId) return;
      await api('/admin/api/pause', { method:'POST', body: JSON.stringify({ waId: currentWaId, paused:false }) });
      await openChat(currentWaId);
    };
  </script>
</body>
</html>
